---
title: "R Notebook"
output: html_notebook
---

Libraries Needed: 
```{r}
library(palmerpenguins)
library(rstan)
library(bayesplot)
library(loo)
library(ggplot2)
```

Setting the work directory: 
```{r}
setwd('/Users/selma/Desktop')
getwd()
```

Loading the Dataset: 
```{r}
penguins = readRDS("penguins.RDS")
```


Visualizations: 
```{r}
dist_bill_length <- ggplot(penguins, aes(x = bill_length)) +
  geom_histogram(bins = 40, fill = '#9f9eaa', color = "black", aes(y = ..count..)) +
  ggtitle("Distribution of Bill Length") +
  ylab("Frequency") + 
  xlab("Bill Length") +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "white"))
ggsave("dist_bill_length.png", dist_bill_length, width = 6, height = 4, units = "in")

dist_bill_depth <- ggplot(penguins, aes(x = bill_depth)) +
  geom_histogram(bins = 40, fill = "#807e82", color = "black", aes(y = ..count..)) +
  ggtitle("Distribution of Bill Depth") +
  ylab("Frequency") + 
  xlab("Bill Depth") +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "white"))
ggsave("dist_bill_depth.png", dist_bill_depth, width = 6, height = 4, units = "in")
```

```{r}
scatter_plot <- ggplot() + geom_point(data = penguins, aes(x = bill_depth, y = bill_length, col = species), size = 1.8) + 
  labs(title = "Bill Depth vs. Bill Length", x = "Bill Depth", y = "Bill Length", color = "Species: ") +
  guides(color = guide_legend(keywidth = 1, keyheight = 1)) +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_color_manual(values = c("#b46c76", "gray27", "#5b586d")) +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "white"))
ggsave("scatter_plot.png", scatter_plot, width = 6, height = 4, units = "in")

dist_species <- ggplot(penguins, aes(x = species)) +
  geom_bar(fill = c('#e4c1c7', '#807e82', '#9f9eaa' )) + 
  labs(title = "Variety of Penguins by Species", y = "Frequency", x = "Species") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme_minimal() +
  theme(panel.background = element_rect(fill = "white"))
ggsave("dist_species.png", dist_species, width = 6, height = 4, units = "in")
```

Implementation of the linear model for the purpose of determining priors: 
```{r}
model <- lm(penguins$bill_length ~ penguins$bill_depth)
summary(model)
```
Checking the mean and the standard deviation of the predictor: 
```{r}
mean(penguins$bill_length)
sd(penguins$bill_length)
```


Preparing data for stan: 
```{r}
data <- list(
  N = nrow(penguins),
  J_species = length(unique(penguins$species)),
  species = as.numeric(penguins$species),
  bill_depth = penguins$bill_depth,
  bill_length = penguins$bill_length
)
```


Running the models: 
```{r}
# model 1 - randomly assigned
stan_model_1 <- stan_model("hierarchical_model_v1.stan")
fit_model_1 <- sampling(stan_model_1, data = data, iter = 4000, chains = 4, verbose = FALSE)
# model 2 - using the values from the linear model 
stan_model_2 <- stan_model("hierarchical_model_v2.stan")
fit_model_2 <- sampling(stan_model_2, data = data, iter = 4000, chains = 4, verbose = FALSE)
# model 3 - other values for the parameters 
stan_model_3 <- stan_model("hierarchical_model_v3.stan")
fit_model_3 <- sampling(stan_model_3, data = data, iter = 4000, chains = 4, verbose = FALSE)
# model 4 - flat model
stan_model_4 <- stan_model("hierarchical_model_flat_priors.stan")
fit_model_4 <- sampling(stan_model_3, data = data, iter = 4000, chains = 4, verbose = FALSE)
```


```{r}

parameters <- c("alpha", "beta", "gamma[1]", "gamma[2]", 'gamma[3]', 'sigma_species', 'sigma')
tp_h1 <- traceplot(fit_model_1, pars=parameters, inc_warmup=TRUE, nrow=4) +
  ggtitle('Traceplot of Hierarchical Model V1')
ggsave("tp_h1.png", tp_h1, width = 6, height = 4, units = "in")
tp_h2 <- traceplot(fit_model_2, pars=parameters, inc_warmup=TRUE, nrow=4) +
  ggtitle('Traceplot of Hierarchical Model V2')
ggsave("tp_h2.png", tp_h2, width = 6, height = 4, units = "in")
to_h3 <- traceplot(fit_model_3, pars=parameters, inc_warmup=TRUE, nrow=4) +
  ggtitle('Traceplot of Hierarchical Model V3')
ggsave("to_h3.png", to_h3, width = 6, height = 4, units = "in")
tp_h4 <- traceplot(fit_model_4, pars=parameters, inc_warmup=TRUE, nrow=4) +
  ggtitle('Traceplot of Hierarchical Model with Flat Priors')
ggsave("to_h4.png", to_h3, width = 6, height = 4, units = "in")
```


```{r}
sp_h1 <- stan_plot(fit_model_1, pars=parameters) +
  ggtitle('Hierarchical Model V1')
ggsave("sp_h1.png", sp_h1, width = 6, height = 4, units = "in")
sp_h2 <- stan_plot(fit_model_2, pars=parameters) +
  ggtitle('Hierarchical Model V2')
ggsave("sp_h2.png", sp_h2, width = 6, height = 4, units = "in")
sp_h3 <- stan_plot(fit_model_3, pars=parameters) +
  ggtitle('Hierarchical Model V3')
ggsave("sp_h3.png", sp_h3, width = 6, height = 4, units = "in")
sp_h4 <- stan_plot(fit_model_4, pars=parameters) +
  ggtitle('Hierarchical Model with Flat Priors')
ggsave("sp_h4.png", sp_h4, width = 6, height = 4, units = "in")
```

```{r}
extract_1 <- extract(fit_model_1)
output_1 <- extract_1$output
extract_2 <- extract(fit_model_2)
output_2 <- extract_2$output
extract_3 <- extract(fit_model_3)
output_3 <- extract_3$output
extract_4 <- extract(fit_model_4)
output_4 <- extract_4$output
```

```{r}
library(knitr)
library(kableExtra)

summary_model_1 <- summary(fit_model_1)
summary_model_2 <- summary(fit_model_2)
summary_model_3 <- summary(fit_model_3)
summary_model_4 <- summary(fit_model_4)

library(knitr)

summary_data <- data.frame(
  Parameter = c("alpha", "beta", "gamma[1]", "gamma[2]", "gamma[3]", "sigma_species", "sigma"),
  mean_m1 = summary_model_1$summary[, "mean", drop = FALSE][1:7],
  rhat_m1 = summary_model_1$summary[, "Rhat", drop = FALSE][1:7],
  mean_m2 = summary_model_2$summary[, "mean", drop = FALSE][1:7],
  rhat_m2 = summary_model_2$summary[, "Rhat", drop = FALSE][1:7],
  mean_m3 = summary_model_3$summary[, "mean", drop = FALSE][1:7],
  rhat_m3 = summary_model_3$summary[, "Rhat", drop = FALSE][1:7],
  mean_m4 = summary_model_4$summary[, "mean", drop = FALSE][1:7],
  rhat_m4 = summary_model_4$summary[, "Rhat", drop = FALSE][1:7]
)

col_names <- c('Parameters', 'Mean M1', 'Rhat M1', 'Mean M2', 'Rhat M2', 'Mean M3', 'Rhat M3', 'Mean FP', 'Rhat FP' )
table <- kable(summary_data, format = "html", align = "c", col.names = col_names) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)


print(table)
```



```{r}
colors <- c("#b46c76", "gray27", "#5b586d", "#b46c76", '#807e82', "#b46c76" )
color_scheme_set(colors)
real_bill_length <- penguins$bill_length
subset_output_1 <- output_1[1:100, ]
subset_output_2 <- output_2[1:100, ]
subset_output_3 <- output_3[1:100, ]
subset_output_4 <- output_4[1:100, ]
dp_1 <- ppc_dens_overlay(real_bill_length, subset_output_1) + 
  panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Density Plot for Hierarchical Model V1') 
ggsave("dp_1.png", dp_1, width = 6, height = 4, units = "in")
dp_2 <- ppc_dens_overlay(real_bill_length, subset_output_2) +
  panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Density Plot for Hierarchical Model V2')
ggsave("dp_2.png", dp_2, width = 6, height = 4, units = "in")
dp_3 <- ppc_dens_overlay(real_bill_length, subset_output_3) +
  panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Density Plot for Hierarchical Model V3')
ggsave("dp_3.png", dp_3, width = 6, height = 4, units = "in")
dp_4 <-ppc_dens_overlay(real_bill_length, subset_output_4) +
  panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Density Plot for Hierarchical Model with Flat Priors')
ggsave("dp_4.png", dp_4, width = 6, height = 4, units = "in")
```




```{r}
color_scheme_set('purple')
hist_mh1 <- ppc_stat(real_bill_length, subset_output_1) +
  panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Hierarchical Model V1') 
ggsave("hist_mh1.png", hist_mh1, width = 6, height = 4, units = "in")
hist_mh2 <- ppc_stat(real_bill_length, subset_output_2) +
    panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Hierarchical Model V2') 
ggsave("hist_mh2.png", hist_mh2, width = 6, height = 4, units = "in")
hist_mh3 <- ppc_stat(real_bill_length, subset_output_3) +
      panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Hierarchical Model V3') 
ggsave("hist_mh3.png", hist_mh3, width = 6, height = 4, units = "in")
hist_mh4 <- ppc_stat(real_bill_length, subset_output_4) +
      panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Hierarchical Model with Flat Priors')
ggsave("hist_mh4.png", hist_mh4, width = 6, height = 4, units = "in")
```

```{r}
ppc_h1 <- ppc_ecdf_overlay(real_bill_length, subset_output_1) +
   panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Hierarchical Model V1') 
ggsave("ppc_h1.png", ppc_h1, width = 6, height = 4, units = "in")
ppc_h2 <- ppc_ecdf_overlay(real_bill_length, subset_output_2) +
     panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Hierarchical Model V2') 
ggsave("ppc_h2.png", ppc_h2, width = 6, height = 4, units = "in")
ppc_h3 <- ppc_ecdf_overlay(real_bill_length, subset_output_3) +
     panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Hierarchical Model V3')
ggsave("ppc_h3.png", ppc_h3, width = 6, height = 4, units = "in")
ppc_h4 <- ppc_ecdf_overlay(real_bill_length, subset_output_4) +
     panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Hierarchical Model with Flat Priors') 
ggsave("ppc_h4.png", ppc_h4, width = 6, height = 4, units = "in")
```

Pooled model: 
```{r}
#pooled model data
pooled_data = list(N = nrow(penguins), x = penguins$bill_depth, y = penguins$bill_length)
# model 1 - randomly assigned
stan_pooled_model_1 <- stan_model("pooled_model_1.stan")
fit_pooled_model_1 <- sampling(stan_pooled_model_1, data = pooled_data, iter = 4000, chains = 4, verbose = FALSE)
# model 2 - using the values from the linear model 
stan_pooled_model_2 <- stan_model("pooled_model_2.stan")
fit_pooled_model_2 <- sampling(stan_pooled_model_2, data = pooled_data, iter = 4000, chains = 4, verbose = FALSE)

```




```{r}
summary_pmodel_1 <- summary(fit_pooled_model_1)
summary_pmodel_2 <- summary(fit_pooled_model_2)

summary_data <- data.frame(
  Parameter = c("alpha", "beta", "sigma"),
  mean_m1 = summary_pmodel_1$summary[, "mean", drop = FALSE][1:3],
  rhat_m1 = summary_pmodel_1$summary[, "Rhat", drop = FALSE][1:3],
  mean_m2 = summary_pmodel_2$summary[, "mean", drop = FALSE][1:3],
  rhat_m2 = summary_pmodel_2$summary[, "Rhat", drop = FALSE][1:3]
)

col_names <- c('Parameters', 'Mean M1', 'Rhat M1', 'Mean M2', 'Rhat M2')
table <- kable(summary_data, format = "html", align = "c", col.names = col_names) %>%
  kable_styling(bootstrap_options = "striped", full_width = FALSE)


print(table)
```

```{r}
extract_pooled_1 <- extract(fit_pooled_model_1)
output_pooled_1 <- extract_pooled_1$y_sim
extract_pooled_2 <- extract(fit_pooled_model_2)
output_pooled_2 <- extract_pooled_2$y_sim
```



```{r}
colors <- c("#b46c76", "gray27", "#5b586d", "#b46c76", '#807e82', "#b46c76" )
color_scheme_set(colors)
real_bill_length <- penguins$bill_length
subset_pooled_output_1 <- output_pooled_1[1:100, ]
subset_pooled_output_2 <- output_pooled_2[1:100, ]
dp_pooled_1 <- ppc_dens_overlay(real_bill_length, subset_pooled_output_1) + 
  panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Density Plot for Pooled Model V1') 
ggsave("dp_pooled_1.png", dp_pooled_1, width = 6, height = 4, units = "in")
dp_pooled_2 <- ppc_dens_overlay(real_bill_length, subset_pooled_output_2) +
  panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Density Plot for Pooled Model V2')
ggsave("dp_pooled_2.png", dp_pooled_2, width = 6, height = 4, units = "in")
```

```{r}
ppc_p1 <- ppc_ecdf_overlay(real_bill_length, subset_pooled_output_1) +
   panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Pooled Model V1') 
ggsave("ppc_p1.png", ppc_p1, width = 6, height = 4, units = "in")
ppc_p2 <- ppc_ecdf_overlay(real_bill_length, subset_pooled_output_2) +
     panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Pooled Model V2') 
ggsave("ppc_p2.png", ppc_p2, width = 6, height = 4, units = "in")
```

```{r}
parameters <- c("alpha", "beta", 'sigma')
tp_p1 <- traceplot(fit_pooled_model_1, pars=parameters, inc_warmup=TRUE, nrow=4) +
  ggtitle('Traceplot of Pooled Model V1')
ggsave("tp_p1.png", tp_p1, width = 6, height = 4, units = "in")
tp_p2 <- traceplot(fit_pooled_model_2, pars=parameters, inc_warmup=TRUE, nrow=4) +
  ggtitle('Traceplot of Pooled Model V2')
ggsave("tp_p2.png", tp_p2, width = 6, height = 4, units = "in")
```

```{r}
hist_mp1 <- ppc_stat(real_bill_length, subset_pooled_output_1) +
  panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Pooled Model V1') 
ggsave("hist_mp1.png", hist_mp1, width = 6, height = 4, units = "in")
hist_mp2 <- ppc_stat(real_bill_length, subset_pooled_output_2) +
    panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Pooled Model V2') 
ggsave("hist_mp2.png", hist_mp2, width = 6, height = 4, units = "in")
```

```{r}
sp_p1 <- stan_plot(fit_pooled_model_1, pars=parameters) +
  ggtitle('Pooled Model V1')
ggsave("sp_p1.png", sp_p1, width = 6, height = 4, units = "in")
sp_p2 <- stan_plot(fit_pooled_model_2, pars=parameters) +
  ggtitle('Pooled Model V2')
ggsave("sp_p2.png", sp_p2, width = 6, height = 4, units = "in")
```


```{r}
loo_model_1 <- loo(fit_model_1)
loo_model_2 <- loo(fit_model_2)
loo_model_3 <- loo(fit_model_3)
loo_model_4 <- loo(fit_model_4)
loo_pooled_model_1 <- loo(fit_pooled_model_1)
loo_pooled_model_2 <- loo(fit_pooled_model_2)
```

```{r}
loo_model_1
loo_model_2
loo_model_3
loo_model_4
loo_pooled_model_1
loo_pooled_model_2
```

```{r}
comp_hier <- loo_compare(loo_model_1, loo_model_2, loo_model_3, loo_model_4)
comp_pooled <- loo_compare(loo_pooled_model_1, loo_pooled_model_2)
comp_pooled_hier <- loo_compare(loo_pooled_model_1, loo_pooled_model_2, loo_model_1, loo_model_2, loo_model_3, loo_model_4)
```

Sensitivity analysis for hierarchal model:
```{r}
stan_model_sensitivity_hier <- stan_model("hierarchical_model_v5.stan")
fit_model_sensitivity_hier <- sampling(stan_model_sensitivity_hier, data = data, iter = 4000, chains = 4, verbose = FALSE)
```

```{r}
real_bill_length <- penguins$bill_length
extract_hier_sens_1 <- extract(fit_model_sensitivity_hier)
output_hier_sens_1 <- extract_hier_sens_1$output
subset_output_hier_sens_1 <- output_hier_sens_1[1:100, ]
sens_hier <- ppc_dens_overlay(real_bill_length, subset_output_hier_sens_1) + 
  panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Sensivity Check for Hierarchal Models') 
ggsave("sens_hier.png", sens_hier, width = 6, height = 4, units = "in")

loo_hier_sens <- loo(fit_model_sensitivity_hier)
loo_hier_sens
```

Sensitivity analysis for the pooled model:
```{r}
stan_pooled_sens <- stan_model("pooled_model_3.stan")
fit_stan_pooled_sens <- sampling(stan_pooled_sens, data = pooled_data, iter = 4000, chains = 4, verbose = FALSE)
```

```{r}
real_bill_length <- penguins$bill_length
extract_pooled_sens_1 <- extract(fit_stan_pooled_sens)
output_pooled_sens_1 <- extract_pooled_sens_1$y_sim
subset_output_hier_sens_1 <- output_pooled_sens_1[1:100, ]
sens_pooled <- ppc_dens_overlay(real_bill_length, subset_output_hier_sens_1) + 
  panel_bg(fill = "white") +
  grid_lines(color = 'lightgray') +
  ggtitle('Sensivity Check for Pooled Models') 
ggsave("sens_pooled.png", sens_pooled, width = 6, height = 4, units = "in")
```


```{r}
loo_pool_sens <- loo(fit_stan_pooled_sens)
loo_compare(loo_pooled_model_1, loo_pooled_model_2, loo_model_1, loo_model_2, loo_model_3, loo_model_4, loo_hier_sens, loo_pool_sens)
```

